(function(a){a.fn.input=function(b){var c=this;if(!b){return c.trigger("keydown.input")}return c.bind({"input.input":function(d){c.unbind("keydown.input");b.call(this,d)},"keydown.input":function(d){b.call(this,d)}})};a.fn.markdownEditor=function(w){w=a.extend({historyRate:2000,screenSplit:"tall",leftSide:0,rightSide:0,fileMenu:0,settingsMenu:"spellbook_settings",TipIt:0,renderRate:300,buttons:["chevron-down","cog","cloud","font","bold","italic","quote-right","beaker","link","picture","list-ul","reply","share-alt","info-sign"],resources:{"icon-bold":"Bold","icon-italic":"Italic","icon-link":"Create link","icon-quote-right":"Quote","icon-beaker":"Code","icon-picture":"Add image","icon-font":"Header","icon-list-ul":"Bullet list","icon-reply":"Undo","icon-share-alt":"Redo","icon-info-sign":"Help","icon-ok":"Accept","icon-remove":"Cancel"},funbuttons:{"chevron-down":"Editor Toggle","icon-cloud":"File Menu","icon-cog":"Settings"}},w);var k=[],r=0,D=new Showdown.converter(),E=function(S,T){if(S=="chevron-down"){if(T=="true"){return'<a class="button button-mobile TBBtn"><span class="fa-icon icon-chevron-down"></span></a>'}else{return'<a class="button button-mobile"><span class="fa-icon icon-chevron-down"></span></a>'}}else{var R="icon-"+S;var e="Magick-"+S;var i;if(w.funbuttons[R]){i=w.funbuttons[R];e+=" FunBtn"}else{i=w.resources[R]}if(S=="bold"){e+=" left"}if(S=="italic"){e+=" right"}if(S=="quote-right"){e+=" left"}if(S=="beaker"){e+=" right"}if(S=="reply"){e+=" left"}if(S=="share-alt"){e+=" right"}if(S=="ok"){return'<a class="button action '+e+'" title="'+i+'"><span class="fa-icon icon-'+S+'"></span><span class="label">Accept</span></a>'}if(S=="remove"){return'<a class="button action '+e+'" title="'+i+'" style="float:right;"><span class="fa-icon icon-'+S+'"></span><span class="label">Remove</span></a>'}if(S=="cloud"){e+=" FileMenu";return'<a class="button action '+e+'" title="'+i+'"><span class="fa-icon red icon-'+S+'"></span><span class="label red">File</span></a>'}if(S=="cog"){e+=" CogMenu";return'<a class="button '+e+'" title="'+i+'"><span class="fa-icon icon-'+S+'"></span></a>'}if(w.TipIt!=0){return'<a class="button '+e+" "+w.TipIt+'" title="'+i+'"><span class="fa-icon icon-'+S+'"></span></a>'}else{return'<a class="button '+e+'" title="'+i+'"><span class="fa-icon icon-'+S+'"></span></a>'}}};var v=a.cookie("spellbook_vc");if(v!=undefined){w.screenSplit=v}var b=(new Date).getTime();var n;if(w.leftSide!=0){if(w.screenSplit=="tall"){startSplit=""}if(w.screenSplit=="wide"){startSplit="splitscreen"}if(w.screenSplit=="full"){startSplit="fullscreen"}n='<div class="markdown-container"><div id="'+w.topSide+'"><div class="markdown-ToolBox"><div class="markdown-toolbar"></div></div></div><div id="'+w.leftSide+'" class="markdown-lefty '+startSplit+'"><textarea class="markdown-editor" id="'+b+'"></textarea></div><div id="'+w.rightSide+'" class="markdown-righty '+startSplit+'"><div class="markdown-preview"></div><div class="push fixBlock"></div></div></div>';n+='<div class="spellbook-fulltoggle"><span class="fa-icon icon-fullscreen icon-2x"></span></div>';$container=a(n),$toolbar=$container.find(".markdown-toolbar"),$toolbox=$container.find(".markdown-ToolBox"),$editor=$container.find(".markdown-editor"),$preview=$container.find(".markdown-preview")}else{$container=a('<div class="markdown-container"><div class="markdown-toolbar"></div><textarea class="markdown-editor" id="'+b+'"></textarea><div class="markdown-preview"></div></div>'),$toolbar=$container.find(".markdown-toolbar"),$editor=$container.find(".markdown-editor"),$preview=$container.find(".markdown-preview")}var Q=$editor[0],s=function(e,R,i){if(!i){return R}while(R>1){if(e[R-1]=="\n"){break}R--}return R},g=function(i,e,R){if(!R){return e}while(e<i.length-1){if(i[e]=="\n"){break}e++}return e},o=("selectionStart" in Q&&function(R){var S=s(Q.value,Q.selectionStart,R);var i=g(Q.value,Q.selectionEnd,R);var e=i-S;return{start:S,end:i,length:e,text:Q.value.substr(S,e)}})||(document.selection&&function(){Q.focus();var i=document.selection.createRange();if(i===null){return{start:0,end:Q.value.length,length:0}}var e=Q.createTextRange();var R=e.duplicate();e.moveToBookmark(i.getBookmark());R.setEndPoint("EndToStart",e);return{start:R.text.length,end:R.text.length+i.text.length,length:i.text.length,text:i.text}})||function(){return null};var u=function(){if(a(".markdown-lefty").hasClass("splitscreen")!=true){var i=a(window).width();var e=jQuery(window).height()-jQuery("#"+w.topSide).height();finalHeight=e-4;jQuery("#"+b).height(finalHeight)}var i=a(window).width();if(i<800){if(jQuery("#"+w.rightSide).hasClass("fullscreen")!=true){p();a("#"+w.rightSide).hide();a(".FullSplit").addClass("on");a(".spellbook-fulltoggle").addClass("fullscreen");a("#"+w.leftSide).addClass("fullscreen");a("#"+w.rightSide).addClass("fullscreen")}}else{if(jQuery(".markdown-ToolBox").hasClass("PanelOpen")==true){jQuery(".markdown-ToolBox").removeClass("PanelOpen");jQuery("#"+w.leftSide).removeClass("DropDown");jQuery("#"+w.topSide).removeClass("DropDown")}if(jQuery("#"+w.rightSide).hasClass("fullscreen")==true){var R=a.cookie("spellbook_vc");if(R!=undefined&&R!="full"){f(R)}}}};var J=("selectionStart" in Q&&function(R,i){var S=s(Q.value,Q.selectionStart,i);var e=g(Q.value,Q.selectionEnd,i);Q.value=Q.value.substr(0,S)+R+Q.value.substr(e,Q.value.length);Q.selectionStart=S;Q.selectionEnd=S+R.length;Q.focus()})||(document.selection&&function(e){Q.focus();document.selection.createRange().text=e})||function(e){Q.value+=e};var B=0;var z=function(){clearTimeout(B);B=setTimeout(function(){if(Q.value!=k[r]){k[++r]=Q.value;if(k.length>r+1){k=k.slice(0,r+1);I.attr("disabled","")}}},w.historyRate);t.removeAttr("disabled");q()};var y=function(){if(r){Q.value=k[--r];I.removeAttr("disabled");q()}r||t.attr("disabled","")};var h=function(){if(r<k.length-1){Q.value=k[++r];if(r===k.length-1){I.attr("disabled","")}q();t.removeAttr("disabled")}};var l=0;var q=function(e){if(!e){clearTimeout(l);l=setTimeout(function(){$preview.html(D.makeHtml(Q.value));$editor.trigger("md.change",Q)},w.renderRate)}else{$preview.html(D.makeHtml(Q.value))}};var N={init:function(){this.browser=this.searchString(this.dataBrowser)||"Other";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"Unknown"},searchString:function(S){for(var e=0;e<S.length;e++){var R=S[e].string;this.versionSearchString=S[e].subString;if(R.indexOf(S[e].subString)!=-1){return S[e].identity}}},searchVersion:function(i){var e=i.indexOf(this.versionSearchString);if(e==-1){return}return parseFloat(i.substring(e+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.userAgent,subString:"Safari",identity:"Safari"},{string:navigator.userAgent,subString:"Opera",identity:"Opera"}]};N.init();a.each(w.buttons,function(e,i){if(i=="chevron-down"){$toolbar.append(E(i));$toolbox.append(E(i,"true"))}else{if(i=="cloud"||i=="cog"){$toolbox.append(E(i))}else{$toolbar.append(E(i))}}});var t=$toolbar.find(".icon-reply");var I=$toolbar.find(".icon-share-alt");var G=function(){var e="<div id='"+w.settingsMenu+"'><div id='spellbook_settings_inner'><div class='p10'>";e+='<p class="m0 p0 L whiteText" style="padding-top:3px;">&nbsp;<span class="fa-icon icon-cog" style="padding:3px;margin:2px;"></span>&nbsp;Editor Settings</p><a class="button settings_toggle" style="float:right;margin:2px 4px 0px 0px;"><span class="fa-icon icon-arrow-up" style="padding:2px;margin:2px"></span></a><div class="push" style="height:10px;"></div>';e+='<div id="SettingsBar"><label for="TheNoteTitle" class="m0 p0 whiteText">Editor Text Size</label><div class="push" style="height:2px;"></div><a class="button left FontButton FBF" id="LessFont"><span class="fa-icon icon-minus-sign"></span></a><a id="RESETFont" class="button middle FontButton"><span class="fa-icon icon-text-height"></span><span class="label">Size</span></a><a id="MoreFont" class="button right FontButton"><span class="fa-icon icon-plus-sign"></span></a><div class="push" style="height:2px;"></div></div>';e+='<div id="ViewBar" class="smallHide"><p class="m0 p0 L whiteText" style="padding-top:13px;">&nbsp;<span class="fa-icon icon-columns" style="padding:3px;margin:2px;"></span>&nbsp;Display Mode</p><span class="push" style="height:2px;"></span><a id="column_split" href="#" class="button ViewButton ColumnSplit"><span class="label activeD">Vertical</span></a><a id="screen_split" href="#" class="button ViewButton ScreenSplit"><span class="label">Horizontal</span></a><a id="full_split" href="#" class="button ViewButton FullSplit"><span class="label">Full Page</span></a><span class="push" style="height:2px;"></span></div>';e+="</div></div></div>";return e};var x=function(R){if(N.browser=="Explorer"&&N.version<=9){var i=document.selection.createRange()}else{var i=o().text.replace(/\n/g,"").trim()}var e='<form class="md-link-form" action="#"><div class="push" style="height:5px"></div><label>Add a New Link</label><div class="push" style="height:5px"></div><input placeholder="Title" type="text" class="md-input md-title"><div class="push" style="height:5px"></div><input placeholder="http://" type="url" class="md-input md-href"><div class="push" style="height:10px"></div>'+E("ok")+E("remove")+'<div class="push" style="height:10px"></div></form>';a("#SpellBookNotes").html(e);if(!i||/^http(s?):\/\//.exec(i)){a("#SpellBookNotes .md-link-form").find(".md-href").val(i);a("#SpellBookNotes .md-link-form").find(".md-title").focus()}else{a("#SpellBookNotes .md-link-form").find(".md-title").val(i);a("#SpellBookNotes .md-link-form").find(".md-href").focus()}jQuery.facebox({div:"#SpellBookNotes"});A(R)};function A(e){a("#facebox .Magick-ok").on("click",function(R){R.preventDefault();var S=a("#facebox .md-title").val();var i=a("#facebox .md-href").val();J(e(S,i));z();a.facebox.close()});a("#facebox .Magick-remove").on("click",function(i){i.preventDefault();a.facebox.close()})}var L=function(S){var e=o(S.block).text;if(!S.block&&/\n/.exec(e)){return}var R=S.regex.exec(e);var i=!R?S.modify(e):S.undo?S.undo(e,S):R[1];J(i,S.block)};var H=[{cmd:"bold",handler:function(){L({modify:function(e){return"**"+e.trim()+"**"},regex:/^\*\*(.*)\*\*$/});z()}},{cmd:"italic",handler:function(){L({modify:function(e){return"*"+e.trim()+"*"},regex:/^\*((\*\*)?([^*]*)(\*\*))?\*$/});z()}},{cmd:"link",shortcut:"⌘+k, ctrl+k",handler:function(){x(function(i,e){return"["+i+"]("+e+")"})}},{cmd:"beaker",shortcut:"shift+⌘+p, shift+ctrl+p",handler:function(){L({modify:function(e){return"`"+e+"`"},regex:/^`([^`]*)`$/});z()}},{cmd:"quote-right",shortcut:"⌘+', ctrl+'",handler:function(){L({modify:function(e){return"> "+e.replace(/\n/g,"\n> ")},undo:function(e){return e.replace(/(^|\n)>[ \t]*(.*)/g,"$1$2")},regex:/((^|\n)>(.*))+$/,block:true});z()}},{cmd:"picture",shortcut:"shift+⌘+i, shift+ctrl+i",handler:function(){x(function(i,e){return"!["+i+"]("+e+' "'+i+'")'})}},{cmd:"font",handler:function(){L({modify:function(e){return"#"+e},regex:/^#(.*)$/,block:true});z()}},{cmd:"list-ul",shortcut:"shift+⌘+l, shift+ctrl+l",handler:function(){L({modify:function(e){return"* "+e.replace(/\n/g,"\n* ")},undo:function(e){return e.replace(/^[\s\t]*\*[ \t]*/mg,"")},regex:/^([\s\t]*\*.*)*$/,block:true});z()}},{cmd:"reply",shortcut:"⌘+z, ctrl+z",handler:y},{cmd:"share-alt",shortcut:"⌘+y, ctrl+y",handler:h},{cmd:"info-sign",shortcut:"shift+⌘+h, shift+ctrl+h",handler:function(){jQuery.facebox({div:"#markup_help_box"})}},{cmd:"chevron-down",handler:function(){if(jQuery(".markdown-ToolBox").hasClass("PanelOpen")==true){jQuery(".markdown-ToolBox").removeClass("PanelOpen");jQuery("#"+w.leftSide).removeClass("DropDown");jQuery("#"+w.topSide).removeClass("DropDown")}else{jQuery(".markdown-ToolBox").addClass("PanelOpen");jQuery("#"+w.leftSide).addClass("DropDown");jQuery("#"+w.topSide).addClass("DropDown")}}},{cmd:"cloud",shortcut:"⌘+s, ctrl+s",handler:function(){jQuery("#"+w.fileMenu).toggleClass("FileShow")}},{cmd:"cog",shortcut:"⌘+,, ctrl+,",handler:function(){jQuery("#"+w.settingsMenu).toggleClass("FileShow")}}];key.filter=function(i){var e=(i.target||i.srcElement).tagName;return !(e=="INPUT"||e=="SELECT")};for(var M=0;M<H.length;M++){var c=H[M],O=c.cmd,F=c.handler;if(O!="chevron-down"&&O!="cloud"){$toolbar.on("click",".icon-"+O,F);key(c.shortcut||"⌘+"+O+", ctrl+"+O,"markdown",F)}if(O=="chevron-down"){$toolbox.on("click",".icon-chevron-down",F)}else{if(O=="cloud"||O=="cog"){$toolbox.on("click",".icon-"+O,F);key(c.shortcut||"⌘+"+O+", ctrl+"+O,"markdown",F)}}}$editor.focusin(function(){key.setScope("markdown")}).focusout(function(){key.setScope()});if(w.internals){var M=w.internals;M.pushHistory=z;M.popHistory=y;M.history=k}w.value&&$editor.val(w.value);$editor.input(z);k[r]=Q.value;q(true);I.attr("disabled","");t.attr("disabled","");this.html($container);if(w.TipIt!=0){jQuery("."+w.TipIt).tipTip()}if(w.fileToggle){var j=".FileMenu, ."+w.fileToggle;jQuery(j).on("click",function(e){e.preventDefault();jQuery("#"+w.fileMenu).toggleClass("FileShow");return false})}var d=14;function K(S){var R="#"+b;var e=jQuery(R).css("font-size");var i=parseInt(e,10);if(S=="RESETFont"){i=d;jQuery(R).css("font-size",d)}if(S=="LessFont"){i--;jQuery(R).css("font-size",i)}if(S=="MoreFont"){i++;jQuery(R).css("font-size",i)}a.cookie("spellbook_fs",i,{expires:364,path:"/"});u()}function p(){if(a("#"+w.leftSide).hasClass("fullscreen")==true){a(".spellbook-fulltoggle").removeClass("fullscreen");a("#"+w.leftSide).removeClass("fullscreen");a("#"+w.rightSide).removeClass("fullscreen")}if(a("#"+w.leftSide).hasClass("splitscreen")==true){a("#"+w.leftSide).removeClass("splitscreen");a("#"+w.rightSide).removeClass("splitscreen")}if(a("#"+w.leftSide).is(":visible")!=true){a("#"+w.leftSide).show()}if(a("#"+w.rightSide).is(":visible")!=true){a("#"+w.rightSide).show()}a(".ViewButton").removeClass("on")}var P=0;function f(e){if(P==0){P++;p();if(e=="screen_split"||e=="wide"){a(".ScreenSplit").addClass("on");a("#"+w.leftSide).addClass("splitscreen");a("#"+w.rightSide).addClass("splitscreen");var i=(a(window).height()*0.5)-a("#"+w.topSide).height()-5;a(".markdown-editor").css("height",i)}else{if(e=="column_split"||e=="tall"){a(".ColumnSplit").addClass("on")}else{if(e=="full_split"||e=="full"){a("#"+w.rightSide).hide();a(".FullSplit").addClass("on");a(".spellbook-fulltoggle").addClass("fullscreen");a("#"+w.leftSide).addClass("fullscreen");a("#"+w.rightSide).addClass("fullscreen")}}}u();AVPLimit=setTimeout(function(){P=0},1000)}}if(w.settingsMenu=="spellbook_settings"){$toolbox.append(G);jQuery(".settings_toggle").on("click",function(e){e.preventDefault();jQuery("#spellbook_settings").toggleClass("FileShow");return false});jQuery(".FontButton").on("click",function(i){i.preventDefault();var e=a(this).attr("id");K(e);return false})}jQuery(".ViewButton").removeClass("on");if(a("#"+w.leftSide).hasClass("splitscreen")==true){jQuery(".ScreenSplit").addClass("on")}else{if(a("#"+w.leftSide).hasClass("fullscreen")){jQuery(".FullSplit").addClass("on")}else{jQuery(".ColumnSplit").addClass("on")}}jQuery(".ViewButton").on("click",function(R){R.preventDefault();var e=a(this).attr("id");f(e);var i;if(e=="screen_split"){i="wide"}else{if(e=="column_split"){i="tall"}else{if(e=="full_split"){i="full"}}}a.cookie("spellbook_vc",i,{expires:364,path:"/"})});a(".spellbook-fulltoggle").on("click",function(e){e.preventDefault();if(a("#"+w.rightSide).is(":visible")==true){a("#"+w.rightSide).hide();a("#"+w.leftSide).show()}else{a("#"+w.leftSide).hide();a("#"+w.rightSide).show()}});jQuery(".markdown-container").append("<div class='none' id='SpellBookNotes'></div>");var m=a.cookie("spellbook_fs");if(m!=undefined){jQuery(".markdown-editor").css("font-size",m+"px")}var C=a.cookie("spellbook_vc");if(C==undefined){C="tall"}f(C);jQuery(window).resize(function(){u()})}})(jQuery);