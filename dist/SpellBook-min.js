(function(a){a.fn.input=function(b){var c=this;if(!b){return c.trigger("keydown.input")}return c.bind({"input.input":function(d){c.unbind("keydown.input");b.call(this,d)},"keydown.input":function(d){b.call(this,d)}})};a.fn.markdownEditor=function(w){w=a.extend({historyRate:2000,screenSplit:"tall",leftSide:0,rightSide:0,fileMenu:0,settingsMenu:"spellbook_settings",TipIt:0,renderRate:300,buttons:["chevron-down","cog","cloud","font","bold","italic","quote-right","beaker","link","picture","list-ul","reply","share-alt","info-sign"],resources:{"icon-bold":"Bold","icon-italic":"Italic","icon-link":"Create link","icon-quote-right":"Quote","icon-beaker":"Code","icon-picture":"Add image","icon-font":"Header","icon-list-ul":"Bullet list","icon-reply":"Undo","icon-share-alt":"Redo","icon-info-sign":"Help","icon-ok":"Accept","icon-remove":"Cancel"},funbuttons:{"chevron-down":"Editor Toggle","icon-cloud":"File Menu","icon-cog":"Settings"}},w);var k=[],r=0,D=new Showdown.converter(),E=function(T,U){if(T=="chevron-down"){if(U=="true"){return'<a class="button button-mobile TBBtn"><span class="fa-icon icon-chevron-down"></span></a>'}else{return'<a class="button button-mobile"><span class="fa-icon icon-chevron-down"></span></a>'}}else{var S="icon-"+T;var e="Magick-"+T;var i;if(w.funbuttons[S]){i=w.funbuttons[S];e+=" FunBtn"}else{i=w.resources[S]}if(T=="bold"){e+=" left"}if(T=="italic"){e+=" right"}if(T=="quote-right"){e+=" left"}if(T=="beaker"){e+=" right"}if(T=="reply"){e+=" left"}if(T=="share-alt"){e+=" right"}if(T=="ok"){return'<a class="button action '+e+'" title="'+i+'"><span class="fa-icon icon-'+T+'"></span><span class="label">Accept</span></a>'}if(T=="remove"){return'<a class="button action '+e+'" title="'+i+'" style="float:right;"><span class="fa-icon icon-'+T+'"></span><span class="label">Remove</span></a>'}if(T=="cloud"){e+=" FileMenu";return'<a class="button action '+e+'" title="'+i+'"><span class="fa-icon red icon-'+T+'"></span><span class="label red">File</span></a>'}if(T=="cog"){e+=" CogMenu";return'<a class="button '+e+'" title="'+i+'"><span class="fa-icon icon-'+T+'"></span></a>'}if(w.TipIt!=0){return'<a class="button '+e+" "+w.TipIt+'" title="'+i+'"><span class="fa-icon icon-'+T+'"></span></a>'}else{return'<a class="button '+e+'" title="'+i+'"><span class="fa-icon icon-'+T+'"></span></a>'}}};var v=a.cookie("spellbook_vc");if(v!=undefined){w.screenSplit=v}var b=(new Date).getTime();var n;if(w.leftSide!=0){if(w.screenSplit=="tall"){startSplit=""}if(w.screenSplit=="wide"){startSplit="splitscreen"}if(w.screenSplit=="full"){startSplit="fullscreen"}n='<div class="markdown-container"><div id="'+w.topSide+'"><div class="markdown-ToolBox"><div class="markdown-toolbar"></div></div></div><div id="'+w.leftSide+'" class="markdown-lefty '+startSplit+'"><textarea class="markdown-editor" id="'+b+'"></textarea></div><div id="'+w.rightSide+'" class="markdown-righty '+startSplit+'"><div class="markdown-preview"></div><div class="push fixBlock"></div></div></div>';n+='<div class="spellbook-fulltoggle"><span class="fa-icon icon-fullscreen icon-2x"></span></div>';$container=a(n),$toolbar=$container.find(".markdown-toolbar"),$toolbox=$container.find(".markdown-ToolBox"),$editor=$container.find(".markdown-editor"),$preview=$container.find(".markdown-preview")}else{$container=a('<div class="markdown-container"><div class="markdown-toolbar"></div><textarea class="markdown-editor" id="'+b+'"></textarea><div class="markdown-preview"></div></div>'),$toolbar=$container.find(".markdown-toolbar"),$editor=$container.find(".markdown-editor"),$preview=$container.find(".markdown-preview")}var R=$editor[0],s=function(e,S,i){if(!i){return S}while(S>1){if(e[S-1]=="\n"){break}S--}return S},g=function(i,e,S){if(!S){return e}while(e<i.length-1){if(i[e]=="\n"){break}e++}return e},o=("selectionStart" in R&&function(S){var T=s(R.value,R.selectionStart,S);var i=g(R.value,R.selectionEnd,S);var e=i-T;return{start:T,end:i,length:e,text:R.value.substr(T,e)}})||(document.selection&&function(){R.focus();var i=document.selection.createRange();if(i===null){return{start:0,end:R.value.length,length:0}}var e=R.createTextRange();var S=e.duplicate();e.moveToBookmark(i.getBookmark());S.setEndPoint("EndToStart",e);return{start:S.text.length,end:S.text.length+i.text.length,length:i.text.length,text:i.text}})||function(){return null};var u=function(){var S=a(window).width();if(a(".markdown-lefty").hasClass("splitscreen")!=true){a("body").css("overflow","auto");var i=jQuery(window).height()-jQuery("#"+w.topSide).height();finalHeight=i-4;jQuery("#"+b).height(finalHeight);var V=jQuery(window).height()-jQuery("#"+w.topSide).height();jQuery("#"+w.leftSide).height(V);jQuery("#"+w.rightSide).height(V);console.debug(V)}else{var U=jQuery(window).height();var e=jQuery("#"+w.topSide).height();var V=U/2;jQuery("#"+w.leftSide).height(V-e);jQuery("#"+w.rightSide).height(V-5);jQuery("#"+w.rightSide).css("top",V+5);a("body").css("overflow","hidden")}if(S<800){if(jQuery("#"+w.rightSide).hasClass("fullscreen")!=true){p();a("#"+w.rightSide).hide();a(".FullSplit").addClass("on");a(".spellbook-fulltoggle").addClass("fullscreen");a("#"+w.leftSide).addClass("fullscreen");a("#"+w.rightSide).addClass("fullscreen")}}else{if(jQuery(".markdown-ToolBox").hasClass("PanelOpen")==true){jQuery(".markdown-ToolBox").removeClass("PanelOpen");jQuery("#"+w.leftSide).removeClass("DropDown");jQuery("#"+w.topSide).removeClass("DropDown")}if(jQuery("#"+w.rightSide).hasClass("fullscreen")==true){var T=a.cookie("spellbook_vc");if(T!=undefined&&T!="full"){f(T)}}}};var K=("selectionStart" in R&&function(S,i){var T=s(R.value,R.selectionStart,i);var e=g(R.value,R.selectionEnd,i);R.value=R.value.substr(0,T)+S+R.value.substr(e,R.value.length);R.selectionStart=T;R.selectionEnd=T+S.length;R.focus()})||(document.selection&&function(e){R.focus();document.selection.createRange().text=e})||function(e){R.value+=e};var B=0;var z=function(){clearTimeout(B);B=setTimeout(function(){if(R.value!=k[r]){k[++r]=R.value;if(k.length>r+1){k=k.slice(0,r+1);I.attr("disabled","")}}},w.historyRate);t.removeAttr("disabled");q()};var y=function(){if(r){R.value=k[--r];I.removeAttr("disabled");q()}r||t.attr("disabled","")};var h=function(){if(r<k.length-1){R.value=k[++r];if(r===k.length-1){I.attr("disabled","")}q();t.removeAttr("disabled")}};var l=0;var q=function(e){if(!e){clearTimeout(l);l=setTimeout(function(){$preview.html(D.makeHtml(R.value));$editor.trigger("md.change",R)},w.renderRate)}else{$preview.html(D.makeHtml(R.value))}};var O={init:function(){this.browser=this.searchString(this.dataBrowser)||"Other";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"Unknown"},searchString:function(T){for(var e=0;e<T.length;e++){var S=T[e].string;this.versionSearchString=T[e].subString;if(S.indexOf(T[e].subString)!=-1){return T[e].identity}}},searchVersion:function(i){var e=i.indexOf(this.versionSearchString);if(e==-1){return}return parseFloat(i.substring(e+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.userAgent,subString:"Safari",identity:"Safari"},{string:navigator.userAgent,subString:"Opera",identity:"Opera"}]};O.init();a.each(w.buttons,function(e,i){if(i=="chevron-down"){$toolbar.append(E(i));$toolbox.append(E(i,"true"))}else{if(i=="cloud"||i=="cog"){$toolbox.append(E(i))}else{$toolbar.append(E(i))}}});var t=$toolbar.find(".icon-reply");var I=$toolbar.find(".icon-share-alt");var G=function(){var e="<div id='"+w.settingsMenu+"'><div id='spellbook_settings_inner'><div class='p10'>";e+='<p class="m0 p0 L whiteText" style="padding-top:3px;">&nbsp;<span class="fa-icon icon-cog" style="padding:3px;margin:2px;"></span>&nbsp;Editor Settings</p><a class="button settings_toggle" style="float:right;margin:2px 4px 0px 0px;"><span class="fa-icon icon-arrow-up" style="padding:2px;margin:2px"></span></a><div class="push" style="height:10px;"></div>';e+='<div id="SettingsBar"><label for="TheNoteTitle" class="m0 p0 whiteText">Editor Text Size</label><div class="push" style="height:2px;"></div><a class="button left FontButton FBF" id="LessFont"><span class="fa-icon icon-minus-sign"></span></a><a id="RESETFont" class="button middle FontButton"><span class="fa-icon icon-text-height"></span><span class="label">Size</span></a><a id="MoreFont" class="button right FontButton"><span class="fa-icon icon-plus-sign"></span></a><div class="push" style="height:2px;"></div></div>';e+='<div id="ViewBar" class="smallHide"><p class="m0 p0 L whiteText" style="padding-top:13px;">&nbsp;<span class="fa-icon icon-columns" style="padding:3px;margin:2px;"></span>&nbsp;Display Mode</p><span class="push" style="height:2px;"></span><a id="column_split" href="#" class="button ViewButton ColumnSplit"><span class="label activeD">Vertical</span></a><a id="screen_split" href="#" class="button ViewButton ScreenSplit"><span class="label">Horizontal</span></a><a id="full_split" href="#" class="button ViewButton FullSplit"><span class="label">Full Page</span></a><span class="push" style="height:2px;"></span></div>';e+="</div></div></div>";return e};var x=function(S){if(O.browser=="Explorer"&&O.version<=9){var i=document.selection.createRange()}else{var i=o().text.replace(/\n/g,"").trim()}var e='<form class="md-link-form" action="#"><div class="push" style="height:5px"></div><label>Add a New Link</label><div class="push" style="height:5px"></div><input placeholder="Title" type="text" class="md-input md-title"><div class="push" style="height:5px"></div><input placeholder="http://" type="url" class="md-input md-href"><div class="push" style="height:10px"></div>'+E("ok")+E("remove")+'<div class="push" style="height:10px"></div></form>';a("#SpellBookNotes").html(e);if(!i||/^http(s?):\/\//.exec(i)){a("#SpellBookNotes .md-link-form").find(".md-href").val(i);a("#SpellBookNotes .md-link-form").find(".md-title").focus()}else{a("#SpellBookNotes .md-link-form").find(".md-title").val(i);a("#SpellBookNotes .md-link-form").find(".md-href").focus()}jQuery.facebox({div:"#SpellBookNotes"});A(S)};function A(e){a("#facebox .Magick-ok").on("click",function(S){S.preventDefault();var T=a("#facebox .md-title").val();var i=a("#facebox .md-href").val();K(e(T,i));z();a.facebox.close()});a("#facebox .Magick-remove").on("click",function(i){i.preventDefault();a.facebox.close()})}var M=function(T){var e=o(T.block).text;if(!T.block&&/\n/.exec(e)){return}var S=T.regex.exec(e);var i=!S?T.modify(e):T.undo?T.undo(e,T):S[1];K(i,T.block)};var H=[{cmd:"bold",handler:function(){M({modify:function(e){return"**"+e.trim()+"**"},regex:/^\*\*(.*)\*\*$/});z()}},{cmd:"italic",handler:function(){M({modify:function(e){return"*"+e.trim()+"*"},regex:/^\*((\*\*)?([^*]*)(\*\*))?\*$/});z()}},{cmd:"link",shortcut:"⌘+k, ctrl+k",handler:function(){x(function(i,e){return"["+i+"]("+e+")"})}},{cmd:"beaker",shortcut:"shift+⌘+p, shift+ctrl+p",handler:function(){M({modify:function(e){return"`"+e+"`"},regex:/^`([^`]*)`$/});z()}},{cmd:"quote-right",shortcut:"⌘+', ctrl+'",handler:function(){M({modify:function(e){return"> "+e.replace(/\n/g,"\n> ")},undo:function(e){return e.replace(/(^|\n)>[ \t]*(.*)/g,"$1$2")},regex:/((^|\n)>(.*))+$/,block:true});z()}},{cmd:"picture",shortcut:"shift+⌘+i, shift+ctrl+i",handler:function(){x(function(i,e){return"!["+i+"]("+e+' "'+i+'")'})}},{cmd:"font",handler:function(){M({modify:function(e){return"#"+e},regex:/^#(.*)$/,block:true});z()}},{cmd:"list-ul",shortcut:"shift+⌘+l, shift+ctrl+l",handler:function(){M({modify:function(e){return"* "+e.replace(/\n/g,"\n* ")},undo:function(e){return e.replace(/^[\s\t]*\*[ \t]*/mg,"")},regex:/^([\s\t]*\*.*)*$/,block:true});z()}},{cmd:"reply",shortcut:"⌘+z, ctrl+z",handler:y},{cmd:"share-alt",shortcut:"⌘+y, ctrl+y",handler:h},{cmd:"info-sign",shortcut:"shift+⌘+h, shift+ctrl+h",handler:function(){jQuery.facebox({div:"#markup_help_box"})}},{cmd:"chevron-down",handler:function(){if(jQuery(".markdown-ToolBox").hasClass("PanelOpen")==true){jQuery(".markdown-ToolBox").removeClass("PanelOpen");jQuery("#"+w.leftSide).removeClass("DropDown");jQuery("#"+w.topSide).removeClass("DropDown")}else{jQuery(".markdown-ToolBox").addClass("PanelOpen");jQuery("#"+w.leftSide).addClass("DropDown");jQuery("#"+w.topSide).addClass("DropDown")}}},{cmd:"cloud",shortcut:"⌘+s, ctrl+s",handler:function(){jQuery("#"+w.fileMenu).toggleClass("FileShow")}},{cmd:"cog",shortcut:"⌘+,, ctrl+,",handler:function(){jQuery("#"+w.settingsMenu).toggleClass("FileShow")}}];key.filter=function(i){var e=(i.target||i.srcElement).tagName;return !(e=="INPUT"||e=="SELECT")};for(var N=0;N<H.length;N++){var c=H[N],P=c.cmd,F=c.handler;if(P!="chevron-down"&&P!="cloud"){$toolbar.on("click",".icon-"+P,F);key(c.shortcut||"⌘+"+P+", ctrl+"+P,"markdown",F)}if(P=="chevron-down"){$toolbox.on("click",".icon-chevron-down",F)}else{if(P=="cloud"||P=="cog"){$toolbox.on("click",".icon-"+P,F);key(c.shortcut||"⌘+"+P+", ctrl+"+P,"markdown",F)}}}$editor.focusin(function(){key.setScope("markdown")}).focusout(function(){key.setScope()});if(w.internals){var N=w.internals;N.pushHistory=z;N.popHistory=y;N.history=k}w.value&&$editor.val(w.value);$editor.input(z);k[r]=R.value;q(true);I.attr("disabled","");t.attr("disabled","");this.html($container);if(w.TipIt!=0){jQuery("."+w.TipIt).tipTip()}if(w.fileToggle){var j=".FileMenu, ."+w.fileToggle;jQuery(j).on("click",function(e){e.preventDefault();jQuery("#"+w.fileMenu).toggleClass("FileShow");return false})}var d=14;function L(T){var S="#"+b;var e=jQuery(S).css("font-size");var i=parseInt(e,10);if(T=="RESETFont"){i=d;jQuery(S).css("font-size",d)}if(T=="LessFont"){i--;jQuery(S).css("font-size",i)}if(T=="MoreFont"){i++;jQuery(S).css("font-size",i)}a.cookie("spellbook_fs",i,{expires:364,path:"/"});u()}function p(){if(a("#"+w.leftSide).hasClass("fullscreen")==true){a(".spellbook-fulltoggle").removeClass("fullscreen");a("#"+w.leftSide).removeClass("fullscreen");a("#"+w.rightSide).removeClass("fullscreen")}if(a("#"+w.leftSide).hasClass("splitscreen")==true){a("#"+w.leftSide).removeClass("splitscreen");a("#"+w.rightSide).removeClass("splitscreen")}if(a("#"+w.leftSide).is(":visible")!=true){a("#"+w.leftSide).show()}if(a("#"+w.rightSide).is(":visible")!=true){a("#"+w.rightSide).show()}a(".ViewButton").removeClass("on")}function J(){a("body").css("overflow","auto");var e=jQuery("#"+w.topSide).height();var i=jQuery(window).height()-e;jQuery("#"+w.leftSide).height(i);jQuery("#"+w.rightSide).height(i);jQuery("#"+w.rightSide).css("top",e);console.debug("fixed column height: "+i)}var Q=0;function f(e){if(Q==0){Q++;p();if(e=="screen_split"||e=="wide"){a(".ScreenSplit").addClass("on");a("#"+w.leftSide).addClass("splitscreen");a("#"+w.rightSide).addClass("splitscreen");var i=(a(window).height()*0.5)-a("#"+w.topSide).height()-5;a(".markdown-editor").css("height",i)}else{if(e=="column_split"||e=="tall"){a(".ColumnSplit").addClass("on");J()}else{if(e=="full_split"||e=="full"){a("#"+w.rightSide).hide();a(".FullSplit").addClass("on");a(".spellbook-fulltoggle").addClass("fullscreen");a("#"+w.leftSide).addClass("fullscreen");a("#"+w.rightSide).addClass("fullscreen");J()}}}u();AVPLimit=setTimeout(function(){Q=0},1000)}}if(w.settingsMenu=="spellbook_settings"){$toolbox.append(G);jQuery(".settings_toggle").on("click",function(e){e.preventDefault();jQuery("#spellbook_settings").toggleClass("FileShow");return false});jQuery(".FontButton").on("click",function(i){i.preventDefault();var e=a(this).attr("id");L(e);return false})}jQuery(".ViewButton").removeClass("on");if(a("#"+w.leftSide).hasClass("splitscreen")==true){jQuery(".ScreenSplit").addClass("on")}else{if(a("#"+w.leftSide).hasClass("fullscreen")){jQuery(".FullSplit").addClass("on")}else{jQuery(".ColumnSplit").addClass("on")}}jQuery(".ViewButton").on("click",function(S){S.preventDefault();var e=a(this).attr("id");f(e);var i;if(e=="screen_split"){i="wide"}else{if(e=="column_split"){i="tall"}else{if(e=="full_split"){i="full"}}}a.cookie("spellbook_vc",i,{expires:364,path:"/"})});a(".spellbook-fulltoggle").on("click",function(e){e.preventDefault();if(a("#"+w.rightSide).is(":visible")==true){a("#"+w.rightSide).hide();a("#"+w.leftSide).show()}else{a("#"+w.leftSide).hide();a("#"+w.rightSide).show()}});jQuery(".markdown-container").append("<div class='none' id='SpellBookNotes'></div>");var m=a.cookie("spellbook_fs");if(m!=undefined){jQuery(".markdown-editor").css("font-size",m+"px")}var C=a.cookie("spellbook_vc");if(C==undefined){C="tall"}f(C);jQuery(window).resize(function(){u()})}})(jQuery);